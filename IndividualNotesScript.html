<script>
/* IndividualNotesScript (self-contained) */

(() => {
  if (window.__OFY_individualNotesInitialized) return;
  window.__OFY_individualNotesInitialized = true;
  // ---------- Tiny DOM helpers ----------
  const $$  = (id) => document.getElementById(id);
  const utils = window.ClientUtils || {};
  const fallbackYMD = () => {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
  };
  const todayYMD = typeof utils.todayYMD === 'function' ? (input) => utils.todayYMD(input) : fallbackYMD;
  const esc = typeof utils.esc === 'function'
    ? (value) => utils.esc(value)
    : (s => String(s || '').replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c])));
  const fallbackRunner = () => (window.google && google.script && google.script.run) || null;
  const getRunner = typeof utils.getRunner === 'function' ? utils.getRunner : fallbackRunner;
  const run = () => getRunner();
  const setStatus = utils.createStatusSetter
    ? utils.createStatusSetter('status')
    : ((msg, tone = 'info') => {
        const el = $$('status'); if (!el) return;
        if (!msg) {
          el.textContent = '';
          el.dataset.state = 'info';
          el.setAttribute('hidden', '');
          return;
        }
        const kind = tone === 'bad' ? 'bad' : tone === 'ok' ? 'ok' : 'info';
        el.textContent = msg;
        el.dataset.state = kind;
        el.removeAttribute('hidden');
      });
  const callServer = typeof utils.call === 'function'
    ? (method, args = [], options) => utils.call(method, args, options)
    : (method, args = [], { onSuccess, onFailure } = {}) => {
        const runner = run();
        if (!runner || typeof runner[method] !== 'function') {
          const err = new Error('Apps Script not available');
          if (typeof onFailure === 'function') {
            try { onFailure(err); } catch(_) {}
          }
          return Promise.reject(err);
        }
        const argArray = Array.isArray(args) ? args : [args];
        return new Promise((resolve, reject) => {
          const proxy = runner
            .withSuccessHandler(res => {
              if (typeof onSuccess === 'function') {
                try { onSuccess(res); } catch(_) {}
              }
              resolve(res);
            })
            .withFailureHandler(err => {
              if (typeof onFailure === 'function') {
                try { onFailure(err); } catch(_) {}
              }
              reject(err);
            });
          try {
            proxy[method](...argArray);
          } catch (err) {
            if (typeof onFailure === 'function') {
              try { onFailure(err); } catch(_) {}
            }
            reject(err);
          }
        });
      };

  // ---------- Form factory ----------
  function createForm(containerId, fields, { cols = 3 } = {}) {
    const root = document.getElementById(containerId);
    if (!root) throw new Error('Form container not found: ' + containerId);

    const grid = document.createElement('div');
    grid.className = cols === 3 ? 'grid-3' : 'grid-3';
    root.innerHTML = '';
    root.appendChild(grid);

    const fieldInputs = new Map();
    const fieldWraps = new Map();
    const notesEl = document.getElementById('notes');

    const setSelectOptions = (sel, options = []) => {
      sel.innerHTML = '';
      options.forEach(opt => {
        const o = document.createElement('option');
        if (typeof opt === 'string') { o.value = opt; o.textContent = opt; }
        else { o.value = String(opt.value ?? opt.label ?? ''); o.textContent = String(opt.label ?? opt.value ?? ''); }
        sel.appendChild(o);
      });
    };

    const getValues = () => {
      const vals = {};
      fields.forEach(f => {
        const el = fieldInputs.get(f.key);
        if (!el) return;
        if (f.type === 'number') vals[f.key] = (el.value === '' ? '' : Number(el.value || 0));
        else vals[f.key] = el.value;
      });
      vals.notes = notesEl ? (notesEl.value || '') : '';
      return vals;
    };

    const applyVisibility = () => {
      const vals = getValues();
      fields.forEach(f => {
        const wrap = fieldWraps.get(f.key);
        if (!wrap) return;
        let show = true;
        if (typeof f.visibleIf === 'function') {
          try { show = !!f.visibleIf(vals); } catch(_) { show = true; }
        }
        wrap.style.display = show ? '' : 'none';
      });
    };

    // render
    fields.forEach(f => {
      const wrap = document.createElement('div');
      wrap.dataset.wrap = f.key;
      if (f.span === 'full') wrap.style.gridColumn = '1 / -1';

      const label = document.createElement('label');
      label.setAttribute('for', f.key);
      label.textContent = f.label + (f.required ? ' *' : '');

      let input;
      if (f.type === 'textarea') {
        input = document.createElement('textarea'); input.rows = f.rows || 3;
      } else if (f.type === 'select') {
        input = document.createElement('select'); setSelectOptions(input, f.options || []);
      } else {
        input = document.createElement('input'); input.type = f.type || 'text';
      }
      input.id = f.key;
      if (f.placeholder) input.placeholder = f.placeholder;

      // default value
      if (f.default !== undefined) {
        const v = (typeof f.default === 'function') ? f.default() : f.default;
        input.value = (v == null ? '' : String(v));
      }

      wrap.appendChild(label);
      wrap.appendChild(input);
      grid.appendChild(wrap);
      fieldInputs.set(f.key, input);
      fieldWraps.set(f.key, wrap);

      input.addEventListener('input', applyVisibility);
      input.addEventListener('change', applyVisibility);
    });

    // initial visibility
    applyVisibility();

    return {
      values: getValues,
      setOptions(key, options) {
        const el = fieldInputs.get(key);
        if (el && el.tagName === 'SELECT') setSelectOptions(el, options);
      },
      setValue(key, value) {
        const el = fieldInputs.get(key);
        if (el) {
          const next = (value == null ? '' : String(value));
          if (el.value !== next) el.value = next;
          applyVisibility();
        }
      }
    };
  }

  // ---------- Field spec ----------
  const FIELDS = [
    { key:'date',          label:'Date of Contact', type:'date',   default: () => todayYMD(), required:true },
    { key:'duration',      label:'Duration (minutes)', type:'number', default: 10, required:true },

    { key:'contactWith',   label:'Contact was with', type:'select', required:true,
      options:[
        {value:'Participant',label:'Participant'},
        {value:'Parent',label:'Parent'},
        {value:'Teacher',label:'Teacher'},
        {value:'CPS Staff',label:'CPS Staff'},
        {value:'Other',label:'Other'}
      ],
      default:'Participant'
    },

    { key:'typeOfContact', label:'Type of Contact', type:'select', required:true,
      options:[
        {value:'In person',label:'In person'},
        {value:'Phone (verbal)',label:'Phone (verbal)'},
        {value:'Phone (text)',label:'Phone (text)'},
        {value:'Email',label:'Email'},
        {value:'Virtual',label:'Virtual'},
        {value:'Social media',label:'Social media'},
        {value:'Other',label:'Other'}
      ],
      default:'In person'
    },

    { key:'success',       label:'Outcome', type:'select', required:true,
      options:[{value:'Successful',label:'Successful'},{value:'Attempted',label:'Attempted'}],
      default:'Successful'
    },

    { key:'topic',         label:'Topic', type:'select', required:true,
      options:[
        'Academic','School Attendance','Group Attendance','Social Emotional Learning',
        'Career Planning','Conflict Resolution','Relationship','Other'
      ],
      default:'Academic'
    },

    { key:'location',      label:'Location', type:'select',
      options:[{value:'School',label:'School'},{value:'Home',label:'Home'},{value:'Other',label:'Other'}],
      default:'School',
      visibleIf: (v) => v.typeOfContact === 'In person'
    },

    { key:'mentorId',      label:'Mentor', type:'select', options:[{value:'',label:'— Select mentor —'}] },

    { key:'referrals',     label:'Referrals', type:'text', span:'full', placeholder:'e.g., School Counselor; Alivio; …' }
  ];

  // ---------- Students widget ----------
  const selectedStudents = [];
  const selectedLookup = new Map();
  const chipRegistry = new Map();
  const normalizeId = (id) => String(id || '').trim().toUpperCase();
  const unmatchedTitle = 'Not found in database (will be saved as Unmatched).';

  function updateSelectionSummary(){
    const count = selectedStudents.length;
    const who = $$('whoLine');
    if (who) {
      who.textContent = count
        ? `${count} student${count === 1 ? '' : 's'} selected`
        : 'No students selected yet';
    }
    const metric = $$('selectedCount');
    if (metric) metric.textContent = count.toLocaleString();
    const stat = $$('statSelected');
    if (stat) stat.textContent = count.toLocaleString();
  }

  function updateMentorSummary(){
    const mentorId = ($$('mentorId')?.value || '').trim();
    const stat = $$('statMentor');
    if (stat) stat.textContent = mentorId ? '1' : '0';
  }

  function updateRecentSummary(value){
    const stat = $$('statRecent');
    if (stat) stat.textContent = Number(value || 0).toLocaleString();
  }

  const scheduleRefreshRecent = (() => {
    let timer = null;
    const runLater = () => {
      timer = null;
      refreshRecent();
    };
    return () => {
      if (timer != null) return;
      timer = window.setTimeout(runLater, 80);
    };
  })();

  function buildChipElement(student){
    const chip = document.createElement('span');
    chip.className = 'chip';
    const label = document.createElement('span');
    label.className = 'chip-label';
    const idSpan = document.createElement('span');
    idSpan.className = 'muted';
    const removeBtn = document.createElement('button');
    removeBtn.type = 'button';
    removeBtn.title = 'Remove';
    removeBtn.setAttribute('aria-label', 'Remove');
    removeBtn.textContent = '×';
    removeBtn.addEventListener('click', () => removeStudent(normalizeId(student.id)));
    chip.append(label, idSpan, removeBtn);
    return chip;
  }

  function updateChipElement(chip, student){
    if (!chip) return;
    const label = chip.querySelector('.chip-label');
    const idSpan = chip.querySelector('.muted');
    if (label) label.textContent = student.name || student.id || '';
    if (idSpan) idSpan.textContent = ` (${student.id || ''})`;
    if (student.unmatched) {
      chip.classList.add('chip-unmatched');
      chip.title = unmatchedTitle;
    } else {
      chip.classList.remove('chip-unmatched');
      if (chip.title === unmatchedTitle) chip.removeAttribute('title');
    }
  }

  function renderStudentChips(){
    const wrap = document.getElementById('studentChips');
    if (!wrap) return;

    if (!selectedStudents.length) {
      chipRegistry.forEach(chip => chip.remove());
      chipRegistry.clear();
      wrap.innerHTML = '';
      const empty = document.createElement('div');
      empty.className = 'muted';
      empty.textContent = 'No students selected yet';
      wrap.appendChild(empty);
      updateSelectionSummary();
      scheduleRefreshRecent();
      return;
    }

    const desired = new Set();
    const fragment = document.createDocumentFragment();
    selectedStudents.forEach(student => {
      const key = normalizeId(student.id);
      desired.add(key);
      let chip = chipRegistry.get(key);
      if (!chip) {
        chip = buildChipElement(student);
        chip.dataset.key = key;
        chipRegistry.set(key, chip);
      }
      updateChipElement(chip, student);
      fragment.appendChild(chip);
    });

    wrap.innerHTML = '';
    wrap.appendChild(fragment);

    chipRegistry.forEach((chip, key) => {
      if (!desired.has(key)) {
        chip.remove();
        chipRegistry.delete(key);
      }
    });

    updateSelectionSummary();
    scheduleRefreshRecent();
  }

  // add helpers
  function addStudentInternal(id, name, { silent = false } = {}) {
    const clean = String(id||'').trim(); if(!clean) return;
    const key = normalizeId(clean);
    if (!key || selectedLookup.has(key)) return;
    const s = { id: clean, name: String(name||'').trim(), unmatched:false };
    selectedStudents.push(s);
    selectedLookup.set(key, s);
    if (!silent) renderStudentChips();
    if (!silent) checkAndFlag(s);
  }
  function addStudent(id, name){ addStudentInternal(id, name, { silent:false }); }
  window.__indiv = window.__indiv || {};
  window.__indiv.addStudent = addStudent;

  function removeStudent(key, { silent = false } = {}) {
    if (!key) return;
    const student = selectedLookup.get(key);
    if (!student) return;
    selectedLookup.delete(key);
    chipRegistry.delete(key);
    const idx = selectedStudents.indexOf(student);
    if (idx >= 0) selectedStudents.splice(idx, 1);
    if (!silent) renderStudentChips();
  }

  function updateChipAppearance(student){
    if (!student) return;
    const key = normalizeId(student.id);
    if (!key || !selectedLookup.has(key)) return;
    const chip = chipRegistry.get(key);
    if (!chip) return;
    updateChipElement(chip, student);
  }

  // server checks to flag unmatched IDs
  async function checkAndFlag(student){
    try{
      const res = await callServer('checkIdStatus', [student.id]).catch(() => ({ ok: false }));
      student.unmatched = !(res && res.ok && res.exists);
      updateChipAppearance(student);
    } catch(_){}
  }

  // ---------- Recent ----------
  function renderRecentGrouped(map){
    const box = $$('recent'); if (!box) return;
    box.innerHTML='';
    const ids = Object.keys(map||{});
    if(!ids.length){
      box.innerHTML = '<div class="muted">No recent contacts.</div>';
      updateRecentSummary(0);
      return;
    }

    const today = new Date();
    today.setHours(0,0,0,0);
    const since = new Date(today);
    since.setDate(since.getDate() - 6);
    let weeklyCount = 0;

    ids.forEach(id=>{
      const arr = map[id] || [];
      const headerName = (arr[0] && arr[0].displayName) ? arr[0].displayName : '';
      const header = document.createElement('div');
      header.style.margin = '10px 0 6px';
      header.innerHTML = headerName
        ? `<strong>${esc(headerName)} <span class="muted">(${esc(id)})</span></strong>`
        : `<strong>ID: ${esc(id)}</strong>`;
      box.appendChild(header);

      arr.forEach(n=>{
        const mentorLine = (n.mentorName || n.mentorId) ? `<div class="muted">Mentor: ${esc(n.mentorName || n.mentorId)}</div>` : '';
        const card=document.createElement('div'); card.className='card';
        card.innerHTML=`
          <div class="card-header"><div class="card-title">
            <span class="name">${esc(n.topic||'(No topic)')}</span>
            <span class="muted id-span">[${esc(n.dateYMD||'')}] · ${esc(n.duration||0)} min · ${esc(n.typeOfContact||'')} · ${esc(n.success||'')}</span>
          </div></div>
          ${n.location?`<div class="muted">Location: ${esc(n.location)}</div>`:''}
          ${mentorLine}
          ${n.notes?`<div>${esc(n.notes)}</div>`:''}
        `;
        box.appendChild(card);

        if (n.dateYMD) {
          const dt = new Date(n.dateYMD);
          if (!Number.isNaN(dt.getTime()) && dt >= since) weeklyCount += 1;
        }
      });
    });

    updateRecentSummary(weeklyCount);
  }
  function refreshRecent(){
    const ids = selectedStudents.map(s=>s.id);
    if(!ids.length){
      const box=$$('recent');
      if (box) box.innerHTML='<div class="muted">No recent contacts.</div>';
      updateRecentSummary(0);
      return;
    }
    callServer('listRecentContactsForIds', [ids, 5])
      .then(map => renderRecentGrouped(map || {}))
      .catch(() => { updateRecentSummary(0); });
  }

  // ---------- Save / Clear ----------
  let form;
  async function onSave(){
    if(!selectedStudents.length){ setStatus('Select at least one student.', 'bad'); return; }
    const v = form.values();
    const payload = {
      contactWith    : v.contactWith,
      typeOfContact  : v.typeOfContact,
      topic          : v.topic,
      success        : v.success,
      notes          : (v.notes || '').trim(),
      location       : (v.typeOfContact === 'In person') ? (v.location || 'School') : '',
      durationMinutes: Number(v.duration || 0),
      referrals      : (v.referrals || '').trim(),
      mentorId       : (v.mentorId || '').trim()
    };
    const dateStr = v.date || todayYMD();
    const idsForQueue = selectedStudents.map(s => s.id);

    setStatus('Saving…', 'info');
    try {
      const res = await callServer('saveIndividualContactSession', [dateStr, selectedStudents, payload]);
      if (res?.ok) {
        callServer('markProcessedByIds', [dateStr, idsForQueue, res.contactId, 'Processed']).catch(()=>{});
        setStatus(`Saved contact (${String(res.contactId||'').slice(0,8)}…) for ${res.participantsSaved} student(s) ✅`, 'ok');
        refreshRecent();
      } else {
        setStatus(res?.error||'Save failed.', 'bad');
      }
    } catch (err) {
      setStatus(err?.message||'Save failed.', 'bad');
    }
  }
  function onClear(){
    selectedStudents.splice(0,selectedStudents.length);
    selectedLookup.clear();
    renderStudentChips();
    $$('studentInput').value=''; $$('manualId').value='';
    form.setValue('date', todayYMD());
    form.setValue('duration','');
    form.setValue('contactWith','Participant');
    form.setValue('typeOfContact','In person');
    form.setValue('success','Successful');
    form.setValue('topic','Academic');
    form.setValue('location','School');
    form.setValue('mentorId','');
    form.setValue('referrals','');
    const notesEl = $$('notes'); if (notesEl) notesEl.value = '';
    setStatus('');
    updateMentorSummary();
    const box=$$('recent'); if (box) box.innerHTML = '<div class="muted">No recent contacts.</div>';
    updateRecentSummary(0);
    $$('studentInput')?.focus();
  }

  // ---------- Query-string helpers (deep link support) ----------
  // Read outer URL params in Apps Script (works even inside the iframe)
  function getQSAsync(){
    return new Promise((resolve) => {
      const api = (window.google && google.script && google.script.url);
      if (!api) {
        // Fallback for local testing (not Apps Script)
        const p = new URLSearchParams(window.location.search || '');
        const raw = (p.get('ids') ?? p.get('id') ?? '').trim();
        const ids = decodeURIComponent(raw).split(/[\s,;|]+/).map(s=>s.trim()).filter(Boolean);
        return resolve({
          ids,
          mentorId: (p.get('mentorId') || p.get('mentor') || '').trim().toUpperCase(),
          date: (p.get('date') || '').trim()
        });
      }

      api.getLocation((loc) => {
        // loc.parameter is an object: { page: "IndividualNotes", ids: "50282476", ... }
        const param = loc && loc.parameter ? loc.parameter : {};

        const raw = String(param.ids ?? param.id ?? '').trim();
        const ids = decodeURIComponent(raw).split(/[\s,;|]+/)
          .map(s => s.trim()).filter(Boolean);

        resolve({
          ids,
          mentorId: String(param.mentorId ?? param.mentor ?? '').trim().toUpperCase(),
          date: String(param.date ?? '').trim()
        });
      });
    });
  }

  // ---------- Boot ----------
  window.addEventListener('DOMContentLoaded', async ()=>{
    try {
      form = createForm('indivForm', FIELDS, { cols: 3 });
      updateSelectionSummary();
      updateRecentSummary(0);
      document.getElementById('mentorId')?.addEventListener('change', updateMentorSummary);

      // one-shot bootstrap: mentors + today
      const boot = await callServer('bootstrapIndividualNotes')
        .catch(() => ({ mentors:[], today:null }));

      const opts = [{ value:'', label:'— Select mentor —'}]
        .concat((boot.mentors||[]).map(m=>({ value:String(m.id||'').toUpperCase(), label: m.name || String(m.id||'') })));
      form.setOptions('mentorId', opts);
      if (boot.today) form.setValue('date', boot.today);
      updateMentorSummary();

      // QS prefill (unchanged)
      const qs = await getQSAsync();
      if (qs.date) form.setValue('date', qs.date);
      if (qs.mentorId) form.setValue('mentorId', qs.mentorId);
      updateMentorSummary();

      if (qs.ids && qs.ids.length) {
        const ids = qs.ids.map(x => String(x||'').trim()).filter(Boolean);
        if (ids.length) {
          // show chips immediately
          ids.forEach(id => addStudentInternal(id, id, { silent:true }));
          renderStudentChips();
          refreshRecent();  // load recents right away

          setStatus(`Loaded ${ids.length} ID${ids.length>1?'s':''} from link.`, 'ok');
          setTimeout(() => setStatus(''), 1200);

          // backfill names (non-blocking)
          callServer('getNamesForIds', [ids])
            .then(list => {
              const nameById = new Map((list||[]).map(x => [String(x.id), String(x.name||'')]));
              let changed = false;
              selectedStudents.forEach(s => {
                const nm = nameById.get(String(s.id));
                if (nm && nm !== s.name) { s.name = nm; changed = true; }
              });
              if (changed) renderStudentChips();
            })
            .catch(()=>{});

          // soft-warn checks
          selectedStudents.forEach(s => checkAndFlag(s));
        }
      }

      if (window.AppSuggest && typeof AppSuggest.wireRosterSuggest === 'function') {
        AppSuggest.wireRosterSuggest({
          input: 'studentInput',
          list: 'studentSuggest',
          manualInput: 'manualId',
          manualButton: 'addIdBtn',
          run,
          onManualAdd: (id) => addStudent(id, id),
          onChoose: (it) => {
            const full = `${it.firstName || ''} ${it.lastName || ''}`.trim();
            addStudent(it.id || it.value || '', full || it.label);
          },
        });
      }
      $$('saveBtn')?.addEventListener('click', onSave);
      $$('clearBtn')?.addEventListener('click', onClear);
      setStatus('');

      // lazy-load "recent" after first paint
      if (typeof window.requestIdleCallback === 'function') {
        window.requestIdleCallback(() => refreshRecent(), { timeout: 80 });
      } else {
        window.setTimeout(refreshRecent, 50);
      }

    } catch (err) {
      setStatus('Load error: ' + (err && err.message ? err.message : String(err)), 'bad');
    }
  });

})();
</script>
