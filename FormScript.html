<!-- formScript.html -->
<script>
/* ===== Dynamic form (matches your original) ===== */

const RAW_FIELDS = Array.isArray(window.FORM_FIELDS) ? window.FORM_FIELDS : [];
const FIELDS = RAW_FIELDS.map(f => {
  const copy = Object.assign({}, f);
  if (Array.isArray(copy.options)) copy.options = copy.options.slice();
  return copy;
});
const REQUIRED_FIELDS = Array.isArray(window.FORM_REQUIRED_FIELDS)
  ? window.FORM_REQUIRED_FIELDS.slice()
  : ['firstName','lastName','cpsIdNumber','intakeDate'];

/* ---- Utils ---- */
const $ = (id)=>document.getElementById(id);
let currentParticipant = null;
const MULTI_CONTROLS = new Map();

const CLIENT = window.ClientUtils || {};
const fallbackTodayYMD = () => {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
};
const todayYMD = typeof CLIENT.todayYMD === 'function' ? (input) => CLIENT.todayYMD(input) : fallbackTodayYMD;
const setStatus = CLIENT.createStatusSetter
  ? CLIENT.createStatusSetter('statusBanner')
  : function(message, state){
      const pill = $('statusBanner');
      if(!pill) return;
      if(typeof state === 'boolean') state = state ? 'ok' : (message ? 'bad' : 'info');
      const mode = state || (message ? 'info' : '');
      if(!message){
        pill.hidden = true;
        pill.textContent = '';
        pill.removeAttribute('data-state');
        return;
      }
      pill.hidden = false;
      pill.dataset.state = mode;
      pill.textContent = message;
    };
const callServer = typeof CLIENT.call === 'function'
  ? (method, args = [], options) => CLIENT.call(method, args, options)
  : (method, args = [], { onSuccess, onFailure } = {}) => {
      const runner = (window.google && google.script && google.script.run) || null;
      if (!runner || typeof runner[method] !== 'function') {
        const err = new Error('Apps Script not available');
        if (typeof onFailure === 'function') {
          try { onFailure(err); } catch(_) {}
        }
        return Promise.reject(err);
      }
      const argArray = Array.isArray(args) ? args : [args];
      return new Promise((resolve, reject) => {
        const proxy = runner
          .withSuccessHandler(res => {
            if (typeof onSuccess === 'function') {
              try { onSuccess(res); } catch(_) {}
            }
            resolve(res);
          })
          .withFailureHandler(err => {
            if (typeof onFailure === 'function') {
              try { onFailure(err); } catch(_) {}
            }
            reject(err);
          });
        try {
          proxy[method](...argArray);
        } catch (err) {
          if (typeof onFailure === 'function') {
            try { onFailure(err); } catch(_) {}
          }
          reject(err);
        }
      });
    };

function gsSerialToDate(n){ if(typeof n!=='number'||!isFinite(n)) return null; const ms=(n-25569)*86400*1000; const d=new Date(ms); return isNaN(d)?null:d;}
function toDateInputValue(v){
  if(v==null||v==='') return '';
  let d; if(v instanceof Date) d=v; else if(typeof v==='number') d=gsSerialToDate(v); else d=new Date(v);
  if(!d||isNaN(d)) return '';
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`;
}
function calcAgeYMD(birthYMD, refYMD){
  if(!birthYMD) return ''; const b=new Date(birthYMD+'T00:00:00'); if(isNaN(b)) return '';
  const r=refYMD?new Date(refYMD+'T00:00:00'):new Date(); if(isNaN(r)) return '';
  let age=r.getFullYear()-b.getFullYear(); const m=r.getMonth()-b.getMonth(); if(m<0||(m===0&&r.getDate()<b.getDate())) age--; return age;
}
function updateAgeField(){
  const birthEl = $('birthDate');
  const intakeEl = $('intakeDate');
  const birth = birthEl ? birthEl.value || '' : '';
  const intake = intakeEl ? intakeEl.value || '' : '';
  const age = calcAgeYMD(birth, intake);
  const out = $('ageAtIntake');
  if(out) out.value = (age === '' ? '' : String(age));
}

function updateStats(){
  let filled = 0;
  let requiredFilled = 0;
  FIELDS.forEach(f=>{
    const el = $(f.key);
    if(!el) return;
    const val = (el.value || '').trim();
    if(val) filled++;
    if(REQUIRED_FIELDS.indexOf(f.key) !== -1 && val){
      requiredFilled++;
    }
  });
  const missing = Math.max(0, REQUIRED_FIELDS.length - requiredFilled);
  const statFields = $('statFields');
  const statRequired = $('statRequired');
  const statMissing = $('statMissing');
  if(statFields) statFields.textContent = String(filled);
  if(statRequired) statRequired.textContent = `${requiredFilled}/${REQUIRED_FIELDS.length}`;
  if(statMissing) statMissing.textContent = String(missing);
}

/* ---- Build form ---- */
function buildForm(){
  const container = $('formContainer');
  container.innerHTML = '';
  const grid = document.createElement('div');
  grid.className = 'grid-3';
  MULTI_CONTROLS.clear();

  FIELDS.forEach(f => {
    const wrap = document.createElement('div');
    wrap.className = 'form-field';
    const label = document.createElement('label');
    label.setAttribute('for', f.key);
    label.textContent = f.label;
    wrap.appendChild(label);

    if (f.type === 'multiselect') {
      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.id = f.key;
      let controller = null;

      if (window.AppSuggest && typeof AppSuggest.createMultiSelect === 'function') {
        controller = AppSuggest.createMultiSelect({
          options: Array.isArray(f.options) ? f.options : [],
          placeholder: f.label || 'Select options',
          hiddenInput: hidden
        });
        wrap.appendChild(controller.root);
      } else {
        const fallback = document.createElement('select');
        fallback.multiple = true;
        (f.options || []).forEach(opt => {
          const o = document.createElement('option');
          o.value = opt;
          o.textContent = opt;
          fallback.appendChild(o);
        });
        wrap.appendChild(fallback);
        controller = {
          root: fallback,
          hidden,
          setValues(values){
            const arr = Array.isArray(values)
              ? values
              : String(values || '').split(/\s*[,;|]\s*/g).map(v => v.trim()).filter(Boolean);
            const set = new Set(arr.map(v => v.toLowerCase()));
            Array.from(fallback.options).forEach(o => {
              o.selected = set.has(String(o.value||'').toLowerCase());
            });
            hidden.value = arr.join('; ');
          },
          getValues(){
            return Array.from(fallback.selectedOptions || []).map(o => String(o.value||'').trim()).filter(Boolean);
          },
          clear(){
            Array.from(fallback.options).forEach(o => o.selected = false);
            hidden.value = '';
            hidden.dispatchEvent(new Event('change', { bubbles:true }));
          }
        };
        fallback.addEventListener('change', () => {
          hidden.value = controller.getValues().join('; ');
        });
      }

      if (controller && typeof controller.clear !== 'function') {
        controller.clear = () => {
          controller.setValues([]);
          hidden.dispatchEvent(new Event('change', { bubbles:true }));
        };
      }

      wrap.appendChild(hidden);
      grid.appendChild(wrap);
      MULTI_CONTROLS.set(f.key, controller);
      return;
    }

    let input;
    if (f.type === 'textarea') {
      input = document.createElement('textarea');
      input.rows = 3;
      wrap.style.gridColumn = '1 / -1';
    } else if (f.type === 'select') {
      input = document.createElement('select');
      (f.options || []).forEach(opt => {
        const o = document.createElement('option');
        o.value = opt;
        o.textContent = opt;
        input.appendChild(o);
      });
    } else {
      input = document.createElement('input');
      input.type = f.type || 'text';
      if (f.readonly) {
        input.readOnly = true;
        input.setAttribute('data-readonly', '');
      }
    }
    input.id = f.key;
    if (input.tagName !== 'SELECT') input.placeholder = f.label;
    wrap.appendChild(input);
    grid.appendChild(wrap);
  });

  container.appendChild(grid);
  const intakeEl = $('intakeDate');
  if (intakeEl) intakeEl.value = todayYMD();
  updateStats();
}

function fillForm(rec){
  rec = rec || {};
  FIELDS.forEach(f=>{
    const el=$(f.key); if(!el) return;
    if(f.key==='intakeDate'){ el.value=todayYMD(); return; }
    let val = rec[f.key]!=null ? rec[f.key] : '';
    if(f.type==='date'){ el.value = toDateInputValue(val); }
    else if(f.type==='select'){
      const exists = Array.from(el.options).some(o=>o.value===String(val));
      if(val!=='' && !exists){ const opt=document.createElement('option'); opt.value=String(val); opt.textContent=String(val); el.insertBefore(opt, el.firstChild); }
      el.value = String(val);
    } else if(f.type==='multiselect'){
      const ctrl = MULTI_CONTROLS.get(f.key);
      if (ctrl) {
        ctrl.setValues(val);
        el.value = ctrl.hidden.value;
      } else {
        const arr = Array.isArray(val)
          ? val
          : String(val || '')
              .split(/\s*[,;|]\s*/g)
              .map(x => x.trim())
              .filter(Boolean);
        el.value = arr.join('; ');
      }
    } else { el.value = String(val); }
  });
  updateAgeField();
  updateStats();
}
function clearForm(opts = {}){
  const skipParticipantReset = !!opts.skipParticipantReset;
  const lookup=$('lookupId');
  const person=$('personSearch');
  const list=$('suggestList');
  if (!skipParticipantReset) {
    if (lookup) lookup.value='';
    if (person) person.value='';
    if (list) list.style.display='none';
  } else if (list) {
    list.style.display='none';
  }
  FIELDS.forEach(f=>{
    const el=$(f.key);
    if(!el) return;
    if (f.type==='multiselect') {
      const ctrl = MULTI_CONTROLS.get(f.key);
      if (ctrl) ctrl.clear();
      el.value='';
    } else {
      el.value='';
    }
  });
  const intakeEl=$('intakeDate'); if(intakeEl) intakeEl.value=todayYMD();
  if (!skipParticipantReset) {
    setParticipant(null);
  } else {
    syncLookupToField();
    renderSelectedParticipant();
  }
  updateStats();
  setStatus('');
  if (!skipParticipantReset && person) person.focus();
}
function syncLookupToField(){
  const lookup=$('lookupId');
  const idVal = lookup ? lookup.value.trim() : '';
  const el=$('cpsIdNumber');
  if(el) el.value=idVal;
}

function formatParticipantName(part){
  if (!part) return '';
  const first = String(part.firstName || '').trim();
  const last = String(part.lastName || '').trim();
  if (first || last) return `${first} ${last}`.trim();
  if (part.label) return String(part.label || '').trim();
  if (part.name) return String(part.name || '').trim();
  return String(part.id || '').trim();
}

function renderSelectedParticipant(){
  const summary = $('selectedSummary');
  const metaWrap = $('selectedMeta');
  const idEl = $('selectedId');
  const schoolEl = $('selectedSchool');
  const gradeEl = $('selectedGrade');
  const clearBtn = $('clearSelectionBtn');
  if (!summary || !metaWrap || !idEl || !schoolEl || !gradeEl) return;

  if (!currentParticipant) {
    summary.textContent = 'No participant selected';
    summary.classList.add('muted');
    summary.classList.remove('unmatched');
    idEl.textContent = '—';
    schoolEl.textContent = '—';
    gradeEl.textContent = '—';
    metaWrap.classList.add('is-empty');
    if (clearBtn) clearBtn.hidden = true;
    return;
  }

  summary.textContent = currentParticipant.name || currentParticipant.id;
  summary.classList.remove('muted');
  if (currentParticipant.unmatched) {
    summary.classList.add('unmatched');
  } else {
    summary.classList.remove('unmatched');
  }
  idEl.textContent = currentParticipant.id || '—';
  schoolEl.textContent = currentParticipant.school || '—';
  gradeEl.textContent = currentParticipant.grade || '—';
  metaWrap.classList.remove('is-empty');
  if (clearBtn) clearBtn.hidden = false;
}

function setParticipant(part){
  if (part && part.id) {
    const id = String(part.id).trim();
    currentParticipant = {
      id,
      firstName: part.firstName || '',
      lastName: part.lastName || '',
      name: formatParticipantName(part),
      school: part.school || '',
      grade: part.grade || '',
      unmatched: !!part.unmatched
    };
    const lookup = $('lookupId');
    if (lookup) lookup.value = id;
    const search = $('personSearch');
    if (search) search.value = currentParticipant.name;
    syncLookupToField();
  } else {
    currentParticipant = null;
    const lookup = $('lookupId');
    if (lookup) lookup.value = '';
    const search = $('personSearch');
    if (search) search.value = '';
    syncLookupToField();
  }
  renderSelectedParticipant();
}

function lookupByIdHandler(idRaw, { showError = true } = {}){
  const id = String(idRaw || '').trim();
  if (!id){
    if (showError) {
      setStatus('Enter a CPS ID Number.', 'bad');
      $('lookupId')?.focus();
    }
    return;
  }
  const lookup=$('lookupId');
  if (lookup) lookup.value = id;
  syncLookupToField();

  setStatus('Looking up CPS ID Number…', 'info');
  const reqId=++lastReqId;
  callServer('lookupById', [id])
    .then(res => {
      if(reqId!==lastReqId) return;
      if(res && res.ok){
        fillForm(res.record);
        $('intakeDate').value=todayYMD();
        updateAgeField();
        setParticipant({
          id: res.record?.cpsIdNumber || id,
          firstName: res.record?.firstName,
          lastName: res.record?.lastName,
          school: res.record?.school,
          grade: res.record?.currentGradeLevel,
          name: formatParticipantName(res.record),
          unmatched: false
        });
        setStatus('Record found and auto-filled.', 'ok');
      } else {
        fillForm({});
        $('cpsIdNumber').value=id;
        updateStats();
        setParticipant({ id, name: id, unmatched: true, school:'', grade:'' });
        setStatus(res && res.error ? res.error : 'Not found.', 'bad');
      }
    })
    .catch(err => {
      if(reqId!==lastReqId) return;
      setStatus(err && err.message ? err.message : 'Lookup failed.', 'bad');
      console.error('lookupById failed:', err);
    });
}

/* ---- Search by ID ---- */
let lastReqId = 0;
function wireSearch(){
  const btn=$('searchBtn'), input=$('lookupId'); if(!btn||!input) return;
  btn.addEventListener('click',(e)=>{
    e.preventDefault();
    lookupByIdHandler(input.value, { showError:true });
  });
  input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('searchBtn').click(); }});
  input.addEventListener('input', syncLookupToField);
}

/* ---- Save ---- */
const saveBtn=$('saveBtn');
if(saveBtn){
  saveBtn.addEventListener('click', ()=>{
    if(saveBtn.disabled) return;
    saveBtn.disabled=true;
    const intake=$('intakeDate'); if(intake) intake.value=todayYMD();
    const payload={};
    FIELDS.forEach(f=>{
      const el=$(f.key);
      if (!el) { payload[f.key]=''; return; }
      if (f.type==='multiselect') {
        const ctrl = MULTI_CONTROLS.get(f.key);
        const selected = ctrl ? ctrl.getValues() : String(el.value||'').split(/\s*[,;|]\s*/g).map(v=>v.trim()).filter(Boolean);
        payload[f.key] = selected.join('; ');
      } else {
        payload[f.key]= String((el.value||'').trim());
      }
    });
    if(!payload.cpsIdNumber){
      setStatus('Please enter a CPS ID Number before saving.', 'bad');
      const lookup=$('lookupId'); if(lookup) lookup.focus();
      saveBtn.disabled=false;
      return;
    }
    setStatus('Saving…', 'info');
    callServer('submitForm', [payload])
      .then(res => {
        if(res && res.ok){
          setStatus('Saved to 2026 ✅', 'ok');
          const indicator = $('saveIndicator');
          if (indicator) {
            indicator.textContent = 'Saved!';
            indicator.classList.remove('is-error');
            indicator.hidden = false;
            indicator.dataset.state = 'ok';
            clearTimeout(indicator._timer);
            indicator._timer = setTimeout(()=>{ indicator.hidden = true; }, 3200);
          }
          clearForm();
          const person=$('personSearch'); if(person) person.focus();
        } else {
          setStatus(res && res.error ? res.error : 'Save failed.', 'bad');
        }
      })
      .catch(err => {
        setStatus(err && err.message ? err.message : 'Save failed.', 'bad');
        const indicator = $('saveIndicator');
        if (indicator) {
          indicator.textContent = 'Save failed';
          indicator.classList.add('is-error');
          indicator.hidden = false;
          clearTimeout(indicator._timer);
          indicator._timer = setTimeout(()=>{ indicator.hidden = true; }, 3600);
        }
      })
      .finally(() => {
        saveBtn.disabled=false;
      });
  });
}

/* ---- Wire on load ---- */
function init(){
  buildForm();
  ['input','change'].forEach(evt=>{
    const birth=$('birthDate'); if(birth) birth.addEventListener(evt, ()=>{ updateAgeField(); updateStats(); });
    const intake=$('intakeDate'); if(intake) intake.addEventListener(evt, ()=>{ updateAgeField(); updateStats(); });
  });
  wireSearch();
  if (window.AppSuggest && typeof AppSuggest.wireRosterSuggest === 'function') {
    AppSuggest.wireRosterSuggest({
      input: 'personSearch',
      list: 'suggestList',
      run: () => (window.google && google.script && google.script.run) || null,
      onChoose: (it) => {
        setParticipant({
          id: it.id || '',
          firstName: it.firstName || '',
          lastName: it.lastName || '',
         label: it.label || '',
         school: it.school || '',
         grade: it.grade || ''
       });
        lookupByIdHandler(it.id || '', { showError: false });
      },
    });
  }
  const intakeEl=$('intakeDate'); if(intakeEl && !intakeEl.value) intakeEl.value=todayYMD();
  const formBody=$('formContainer');
  if(formBody){
    formBody.addEventListener('input', updateStats);
    formBody.addEventListener('change', updateStats);
  }
  const clearTop=$('clearBtn'); if(clearTop) clearTop.addEventListener('click', clearForm);
  const clearBottom=$('footerClearBtn'); if(clearBottom) clearBottom.addEventListener('click', clearForm);
  $('clearSelectionBtn')?.addEventListener('click', () => {
    setParticipant(null);
  });
  renderSelectedParticipant();
  updateStats();
}
if(document.readyState==='loading'){
  document.addEventListener('DOMContentLoaded', init);
}else{
  init();
}
</script>
