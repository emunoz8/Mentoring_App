<!-- formScript.html -->
<script>
/* ===== Dynamic form (matches your original) ===== */

const FIELDS = [
  { key:'emailAddress',        label:'Email Address' },
  { key:'lastName',            label:'Last Name' },
  { key:'firstName',           label:'First Name' },
  { key:'intakeDate',          label:'Intake Date', type:'date', readonly:true },
  { key:'participantStatus',   label:'Participant Status' },
  { key:'joinedProgramYear',   label:"Joined What's Up in Program Year" },
  { key:'birthDate',           label:'Birth Date', type:'date' },

  { key:'gender', label:'Gender', type:'select',
    options:['Male','Female','Nonbinary/Genderqueer','Transgender','Cisgender','Prefer not to say'] },

  { key:'address',             label:'Address' },
  { key:'zipCode',             label:'Zip Code' },
  { key:'participantPhone',    label:'Participant Telephone Number' },
  { key:'parentPhone',         label:'Parent Telephone Number' },
  { key:'participantEmails',   label:'Participant Email(s)' },
  { key:'race',                label:'Race' },
  { key:'spanishOnly',         label:'Spanish-Language Only' },

  { key:'ageAtIntake',         label:'Age at Intake [number]', type:'number', readonly:true },

  { key:'gradeAtIntake',       label:'Grade at Intake' },
  { key:'currentGradeLevel',   label:'Current Grade Level' },
  { key:'school',              label:'School' },
  { key:'cpsIdNumber',         label:'CPS ID Number' },

  { key:'familyType', label:'Family Type', type:'select',
    options:['Single Parent/Female','Single Parent/Male','Two-parent Household','Independent Youth','Relative','Guardian','Foster/DCFS'] },

  { key:'householdSize',       label:'Household Size [number]', type:'number' },
  { key:'siblingsCount',       label:'How Many Siblings? [number]', type:'number' },
  { key:'grandparentsInHouse', label:'How Many Grandparents in House? [number]', type:'number' },

  { key:'housingStatus', label:'Housing Status', type:'select',
    options:['Rent','Own','Homeless/Shelter','In temporary Housing','Other'] },

  { key:'incomeSource',  label:'Income Source', type:'select',
    options:[
      'Employment-One Parent/Guardian','Employment-Both Parents/Guardians','Employment-Participant',
      'Pension','TANF','Social Security','Unemployment','Other(including SSDI, Child Support, VA benefits)','SSI'
    ] },

  { key:'yearlyIncome',        label:'Yearly Income [if known]' },

  { key:'publicAssistance', label:'Public Assistance', type:'select',
    options:['SNAP','TANF','Medicaid','SSI'] },

  { key:'healthInsurance',     label:'Health Insurance' },

  { key:'everWorked', label:'Have You Ever Worked? (Select all that apply)', type:'select',
    options:['I have never worked','I have had summer jobs','I have worked part-time during the school year','I have worked full-time during the school year'] },

  { key:'workingNow', label:'Are You Working Now?', type:'select',
    options:['Working full-time','Working part-time','Not working, looking for work','Not working, not looking for work'] },

  { key:'hasIEP',              label:'Do You Have an IEP?' },
  { key:'has504',              label:'Any Medical Issues or 504 Plan?' },
  { key:'medicalIssues',       label:'If Yes, What Are Your Medical Issues?', type:'textarea' },

  { key:'relationshipStatus', label:'Relationship Status', type:'select',
    options:['Currently dating','Not currently dating, not looking','Not dating, not looking','Other'] },

  { key:'grades', label:'Are Your Grades:', type:'select',
    options:["Mostly A's","Mostly B's","Mostly C's","Mostly Below C's"] },

  { key:'attendance', label:'How Would You Describe, Your School Attendance?', type:'select',
    options:['Almost Never Miss a Day','Occasionally Miss a Day','Frequently Miss Days'] },

  { key:'punctuality', label:'How Would You Describe Getting to School on Time?', type:'select',
    options:['Always on Time','Occasionally Late','Sometimes Late','Always Late'] },

  { key:'involvementTeachers', label:'Involvement with Teachers (1-5) (1 being very comfortable)', type:'select',
    options:['1','2','3','4','5'] },

  { key:'involvementStaff', label:'Involvement with School Staff (1-5) (1 being very comfortable)', type:'select',
    options:['1','2','3','4','5'] },

  { key:'extracurricular',     label:'Extracurricular Activities' },
  { key:'comments',            label:'Comments / Concerns', type:'textarea' },
];

const REQUIRED_FIELDS = ['firstName','lastName','cpsIdNumber','intakeDate'];

/* ---- Utils ---- */
const $ = (id)=>document.getElementById(id);

function gsSerialToDate(n){ if(typeof n!=='number'||!isFinite(n)) return null; const ms=(n-25569)*86400*1000; const d=new Date(ms); return isNaN(d)?null:d;}
function toDateInputValue(v){
  if(v==null||v==='') return '';
  let d; if(v instanceof Date) d=v; else if(typeof v==='number') d=gsSerialToDate(v); else d=new Date(v);
  if(!d||isNaN(d)) return '';
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), dd=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${dd}`;
}
function todayYMD(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function calcAgeYMD(birthYMD, refYMD){
  if(!birthYMD) return ''; const b=new Date(birthYMD+'T00:00:00'); if(isNaN(b)) return '';
  const r=refYMD?new Date(refYMD+'T00:00:00'):new Date(); if(isNaN(r)) return '';
  let age=r.getFullYear()-b.getFullYear(); const m=r.getMonth()-b.getMonth(); if(m<0||(m===0&&r.getDate()<b.getDate())) age--; return age;
}
function updateAgeField(){
  const birthEl = $('birthDate');
  const intakeEl = $('intakeDate');
  const birth = birthEl ? birthEl.value || '' : '';
  const intake = intakeEl ? intakeEl.value || '' : '';
  const age = calcAgeYMD(birth, intake);
  const out = $('ageAtIntake');
  if(out) out.value = (age === '' ? '' : String(age));
}

function setStatus(message, state){
  const pill = $('statusBanner');
  if(!pill) return;
  if(typeof state === 'boolean') state = state ? 'ok' : (message ? 'bad' : 'info');
  const mode = state || (message ? 'info' : '');
  if(!message){
    pill.hidden = true;
    pill.textContent = '';
    pill.removeAttribute('data-state');
    return;
  }
  pill.hidden = false;
  pill.dataset.state = mode;
  pill.textContent = message;
}

function updateStats(){
  let filled = 0;
  let requiredFilled = 0;
  FIELDS.forEach(f=>{
    const el = $(f.key);
    if(!el) return;
    const val = (el.value || '').trim();
    if(val) filled++;
    if(REQUIRED_FIELDS.indexOf(f.key) !== -1 && val){
      requiredFilled++;
    }
  });
  const missing = Math.max(0, REQUIRED_FIELDS.length - requiredFilled);
  const statFields = $('statFields');
  const statRequired = $('statRequired');
  const statMissing = $('statMissing');
  if(statFields) statFields.textContent = String(filled);
  if(statRequired) statRequired.textContent = `${requiredFilled}/${REQUIRED_FIELDS.length}`;
  if(statMissing) statMissing.textContent = String(missing);
}

/* ---- Build form ---- */
function buildForm(){
  const container = $('formContainer');
  container.innerHTML = '';
  const grid = document.createElement('div');
  grid.className = 'grid-3';
  FIELDS.forEach(f=>{
    const wrap=document.createElement('div');
    wrap.className='form-field';
    const label=document.createElement('label'); label.setAttribute('for', f.key); label.textContent=f.label;
    let input;
    if(f.type==='textarea'){ input=document.createElement('textarea'); input.rows=3; wrap.style.gridColumn='1 / -1'; }
    else if(f.type==='select'){ input=document.createElement('select'); (f.options||[]).forEach(opt=>{ const o=document.createElement('option'); o.value=opt; o.textContent=opt; input.appendChild(o); }); }
    else { input=document.createElement('input'); input.type=f.type||'text'; if(f.readonly){ input.readOnly=true; input.setAttribute('data-readonly',''); } }
    input.id=f.key; if(input.tagName!=='SELECT') input.placeholder=f.label;
    wrap.appendChild(label); wrap.appendChild(input); grid.appendChild(wrap);
  });
  container.appendChild(grid);
  const intakeEl=$('intakeDate'); if(intakeEl) intakeEl.value=todayYMD();
  updateStats();
}

/* ---- Fill/Clear ---- */
function fillForm(rec){
  rec = rec || {};
  FIELDS.forEach(f=>{
    const el=$(f.key); if(!el) return;
    if(f.key==='intakeDate'){ el.value=todayYMD(); return; }
    let val = rec[f.key]!=null ? rec[f.key] : '';
    if(f.type==='date'){ el.value = toDateInputValue(val); }
    else if(f.type==='select'){
      const exists = Array.from(el.options).some(o=>o.value===String(val));
      if(val!=='' && !exists){ const opt=document.createElement('option'); opt.value=String(val); opt.textContent=String(val); el.insertBefore(opt, el.firstChild); }
      el.value = String(val);
    } else { el.value = String(val); }
  });
  updateAgeField();
  updateStats();
}
function clearForm(){
  const lookup=$('lookupId'); if(lookup) lookup.value='';
  const person=$('personSearch'); if(person) person.value='';
  const list=$('suggestList'); if(list) list.style.display='none';
  FIELDS.forEach(f=>{ const el=$(f.key); if(el) el.value=''; });
  const intakeEl=$('intakeDate'); if(intakeEl) intakeEl.value=todayYMD();
  syncLookupToField();
  updateStats();
  setStatus('');
  if(person) person.focus();
}
function syncLookupToField(){
  const lookup=$('lookupId');
  const idVal = lookup ? lookup.value.trim() : '';
  const el=$('cpsIdNumber');
  if(el) el.value=idVal;
}

/* ---- Search by ID ---- */
let lastReqId = 0;
function wireSearch(){
  const btn=$('searchBtn'), input=$('lookupId'); if(!btn||!input) return;
  btn.addEventListener('click',(e)=>{
    e.preventDefault();
    const id=input.value.trim(); if(!id){ setStatus('Enter a CPS ID Number.', 'bad'); return; }
    syncLookupToField(); setStatus('Looking up CPS ID Numberâ€¦', 'info');
    const reqId=++lastReqId;
    google.script.run
      .withSuccessHandler(res=>{
        if(reqId!==lastReqId) return;
        if(res && res.ok){ fillForm(res.record); $('intakeDate').value=todayYMD(); updateAgeField(); setStatus('Record found and auto-filled.', 'ok'); }
        else { fillForm({}); $('cpsIdNumber').value=id; updateStats(); setStatus(res && res.error ? res.error : 'Not found.', 'bad'); }
      })
      .withFailureHandler(err=>{ if(reqId!==lastReqId) return; setStatus(err && err.message ? err.message : 'Lookup failed.', 'bad'); console.error('lookupById failed:', err); })
      .lookupById(id);
  });
  input.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ e.preventDefault(); $('searchBtn').click(); }});
  input.addEventListener('input', syncLookupToField);
}

/* ---- Typeahead ---- */
function wireSuggest(){
  const input=$('personSearch'), list=$('suggestList');
  let items=[], active=-1, pending=0;
  const debounce=(fn,ms=180)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); }; };
  function render(results){ items=results||[]; active=-1; list.innerHTML=''; if(!items.length){ list.style.display='none'; return; }
    items.forEach((it,idx)=>{ const li=document.createElement('li'); li.className='suggest-item'; li.textContent=it.label;
      li.dataset.idx=idx; li.addEventListener('mouseenter',()=>setActive(idx)); li.addEventListener('mouseleave',()=>setActive(-1)); li.addEventListener('click',()=>choose(idx)); list.appendChild(li); });
    list.style.display='block';
  }
  function setActive(idx){ Array.from(list.children).forEach((el,i)=>el.classList.toggle('active', i===idx)); active=idx; }
  function choose(idx){
    const it=items[idx]; if(!it) return;
    $('personSearch').value=it.label;
    $('firstName').value=it.firstName||''; $('lastName').value=it.lastName||''; $('cpsIdNumber').value=it.id||''; $('lookupId').value=it.id||'';
    updateStats();
    list.style.display='none'; $('searchBtn').click();
  }
  const doSuggest=debounce(()=>{ const q=input.value.trim(); if(q.length<2){ render([]); return; }
    const callId=++pending;
    google.script.run.withSuccessHandler(res=>{ if(callId!==pending) return; render(res||[]); })
      .withFailureHandler(()=>render([])).suggestPeople(q,10);
  },180);
  input.addEventListener('input',doSuggest);
  input.addEventListener('focus',()=>{ if(items.length) list.style.display='block'; });
  document.addEventListener('click',(e)=>{ if(!list.contains(e.target) && e.target!==input) list.style.display='none'; });
  input.addEventListener('keydown',(e)=>{ if(list.style.display==='none'||!items.length) return;
    if(e.key==='ArrowDown'){ e.preventDefault(); setActive(Math.min(items.length-1, active+1)); }
    else if(e.key==='ArrowUp'){ e.preventDefault(); setActive(Math.max(0, active-1)); }
    else if(e.key==='Enter'){ if(active>=0){ e.preventDefault(); choose(active);} }
    else if(e.key==='Escape'){ list.style.display='none'; }
  });
}

/* ---- Save ---- */
const saveBtn=$('saveBtn');
if(saveBtn){
  saveBtn.addEventListener('click', ()=>{
    if(saveBtn.disabled) return;
    saveBtn.disabled=true;
    const intake=$('intakeDate'); if(intake) intake.value=todayYMD();
    const payload={};
    FIELDS.forEach(f=>{
      const el=$(f.key);
      payload[f.key]= el ? String((el.value||'').trim()) : '';
    });
    if(!payload.cpsIdNumber){
      setStatus('Please enter a CPS ID Number before saving.', 'bad');
      const lookup=$('lookupId'); if(lookup) lookup.focus();
      saveBtn.disabled=false;
      return;
    }
    setStatus('Savingâ€¦', 'info');
    google.script.run
      .withSuccessHandler(res=>{
        if(res && res.ok){
          setStatus('Saved to 2026 âœ…', 'ok');
          clearForm();
          const person=$('personSearch'); if(person) person.focus();
        } else {
          setStatus(res && res.error ? res.error : 'Save failed.', 'bad');
        }
        saveBtn.disabled=false;
      })
      .withFailureHandler(err=>{
        setStatus(err && err.message ? err.message : 'Save failed.', 'bad');
        saveBtn.disabled=false;
      })
      .submitForm(payload);
  });
}

/* ---- Wire on load ---- */
function init(){
  buildForm();
  ['input','change'].forEach(evt=>{
    const birth=$('birthDate'); if(birth) birth.addEventListener(evt, ()=>{ updateAgeField(); updateStats(); });
    const intake=$('intakeDate'); if(intake) intake.addEventListener(evt, ()=>{ updateAgeField(); updateStats(); });
  });
  wireSearch();
  if (window.AppSuggest && typeof AppSuggest.wireRemoteSuggest === 'function') {
    AppSuggest.wireRemoteSuggest({
      input: 'personSearch',
      list: 'suggestList',
      minChars: 2,
      limit: 10,
      clearOnChoose: false,
      placeholder: 'e.g., Jane, Doe, 123456',
      run: () => (window.google && google.script && google.script.run) || null,
      formatLabel: (it) => {
        if (!it) return '';
        if (it.label) return String(it.label);
        const full = `${it.firstName || ''} ${it.lastName || ''}`.trim();
        return full || String(it.id || '');
      },
      onChoose: (it) => {
        $('personSearch').value = it.label || `${it.firstName || ''} ${it.lastName || ''}`.trim();
        $('firstName').value = it.firstName || '';
        $('lastName').value = it.lastName || '';
        $('cpsIdNumber').value = it.id || '';
        $('lookupId').value = it.id || '';
        updateStats();
        $('searchBtn').click();
      },
    });
  }
  const intakeEl=$('intakeDate'); if(intakeEl && !intakeEl.value) intakeEl.value=todayYMD();
  const formBody=$('formContainer');
  if(formBody){
    formBody.addEventListener('input', updateStats);
    formBody.addEventListener('change', updateStats);
  }
  const clearTop=$('clearBtn'); if(clearTop) clearTop.addEventListener('click', clearForm);
  const clearBottom=$('footerClearBtn'); if(clearBottom) clearBottom.addEventListener('click', clearForm);
  updateStats();
}
if(document.readyState==='loading'){
  document.addEventListener('DOMContentLoaded', init);
}else{
  init();
}
</script>
