<script>
(function () {
  if (window.__OFY_groupKioskInitialized) return;
  window.__OFY_groupKioskInitialized = true;

  const App = {
    state: {
      session: null,
      roster: [],
      selected: null,
    },
    suggestHandle: null,
    rosterResolver: null,
    rosterRenderer: null,
  };
  window.__OFY_groupKiosk = App;

  function $(id) { return document.getElementById(id); }

  function showStatus(message, tone) {
    const banner = $('statusBanner');
    if (!banner) return;
    if (!message) {
      banner.textContent = '';
      banner.hidden = true;
      banner.setAttribute('hidden', '');
      return;
    }
    banner.textContent = message;
    banner.dataset.state = tone === 'ok' ? 'ok' : tone === 'bad' ? 'bad' : 'info';
    banner.hidden = false;
    banner.removeAttribute('hidden');
  }

  function closeSuggestMenu() {
    if (App.suggestHandle && typeof App.suggestHandle.close === 'function') {
      App.suggestHandle.close();
    }
  }

  function formatStudentDisplay(entry) {
    if (!entry) return '';
    const full = `${entry.firstName || ''} ${entry.lastName || ''}`.trim();
    return full || entry.id || '';
  }

  function normalizeRosterItem(item) {
    if (window.AppSuggest && typeof AppSuggest.normalizeRosterEntry === 'function') {
      return AppSuggest.normalizeRosterEntry(item);
    }
    if (!item) return null;
    const norm = (value) => String(value || '').trim();
    const entry = {
      id: norm(item.id || item.value),
      firstName: norm(item.firstName),
      lastName: norm(item.lastName),
      school: norm(item.school),
      email: norm(item.email),
      grade: norm(item.grade),
      label: norm(item.label),
    };
    entry._fullName = `${entry.firstName} ${entry.lastName}`.trim();
    const normalizeSearch = (val) => String(val || '').toLowerCase();
    entry._searchFields = [
      entry.id,
      entry.firstName,
      entry.lastName,
      entry._fullName,
      entry.school,
      entry.email,
      entry.grade,
    ].map(normalizeSearch);
    if (!entry.label) {
      entry.label = entry._fullName ? `${entry._fullName} · ${entry.id}` : entry.id;
    }
    return entry;
  }

  function setRoster(list) {
    App.state.roster = Array.isArray(list)
      ? list.map((item) => normalizeRosterItem(item)).filter(Boolean)
      : [];
  }

  function ensureRosterHelpers() {
    if (!window.AppSuggest) return;
    if (!App.rosterResolver && typeof AppSuggest.createRosterLocalResolver === 'function') {
      App.rosterResolver = AppSuggest.createRosterLocalResolver(() => App.state.roster, { limit: 12 });
    }
    if (!App.rosterRenderer && typeof AppSuggest.createRosterItemRenderer === 'function') {
      App.rosterRenderer = AppSuggest.createRosterItemRenderer();
    }
  }

  function renderSelectedStudent() {
    const card = $('selectedStudentCard');
    const meta = $('selectedStudentMeta');
    const summary = $('selectedStudentSummary');
    const button = $('signInKnownBtn');
    if (!card || !meta || !summary || !button) return;
    const selected = App.state.selected;
    if (!selected) {
      card.classList.add('muted');
      meta.classList.add('is-empty');
      summary.textContent = 'No student selected.';
      Array.from(meta.querySelectorAll('.fact-value')).forEach((el) => el.textContent = '-');
      button.disabled = true;
      return;
    }
    card.classList.remove('muted');
    meta.classList.remove('is-empty');
    summary.textContent = formatStudentDisplay(selected) || selected.id;
    const cells = meta.querySelectorAll('.fact-value');
    if (cells[0]) cells[0].textContent = selected.id || '-';
    if (cells[1]) cells[1].textContent = selected.school || '-';
    if (cells[2]) cells[2].textContent = selected.email || '-';
    button.disabled = false;
  }

  function clearSelectedStudent() {
    App.state.selected = null;
    const input = $('studentSearch');
    if (input) input.value = '';
    closeSuggestMenu();
    renderSelectedStudent();
  }

  function handleSearchInputChange() {
    const input = $('studentSearch');
    if (!input) return;
    if (!App.state.selected) return;
    const display = formatStudentDisplay(App.state.selected).trim();
    if (display && display === input.value.trim()) return;
    App.state.selected = null;
    renderSelectedStudent();
  }

  function wireSuggest() {
    if (!window.AppSuggest || typeof AppSuggest.wireRosterSuggest !== 'function') return;
    ensureRosterHelpers();
    if (!App.rosterResolver && typeof AppSuggest.createRosterLocalResolver === 'function') {
      App.rosterResolver = AppSuggest.createRosterLocalResolver(() => App.state.roster, { limit: 12 });
    }
    if (!App.rosterRenderer && typeof AppSuggest.createRosterItemRenderer === 'function') {
      App.rosterRenderer = AppSuggest.createRosterItemRenderer();
    }
    App.suggestHandle = AppSuggest.wireRosterSuggest({
      input: 'studentSearch',
      list: 'studentSuggestList',
      minChars: 2,
      limit: 12,
      rpc: 'signInSuggestPeople',
      placeholder: 'Start typing your first or last name…',
      clearOnChoose: false,
      localResolver: App.rosterResolver || null,
      resultMapper: normalizeRosterItem,
      renderItem: App.rosterRenderer || undefined,
      onChoose(item) {
        App.state.selected = item ? Object.assign({}, item) : null;
        const input = $('studentSearch');
        if (input && item) {
          input.value = formatStudentDisplay(item) || item.id || '';
        }
        renderSelectedStudent();
      }
    });
  }

  function openManualSheet() {
    const sheet = $('manualSheet');
    if (!sheet) return;
    closeSuggestMenu();
    sheet.classList.add('is-open');
    sheet.setAttribute('aria-hidden', 'false');
    window.setTimeout(() => {
      const idField = $('manualId');
      if (idField) idField.focus();
    }, 120);
  }

  function closeManualSheet() {
    const sheet = $('manualSheet');
    if (!sheet) return;
    sheet.classList.remove('is-open');
    sheet.setAttribute('aria-hidden', 'true');
  }

  function recordKnownSignIn() {
    const selected = App.state.selected;
    const button = $('signInKnownBtn');
    if (!selected || !App.state.session) {
      showStatus('Pick your name first.', 'bad');
      return;
    }
    if (button) button.disabled = true;
    showStatus('Recording attendance…', 'info');
    const payload = {
      sessionId: App.state.session.id,
      sessionRow: App.state.session.rowIndex || null,
      student: selected
    };
    window.google.script.run
      .withSuccessHandler((res) => {
        if (!res || !res.ok) {
          showStatus((res && res.error) || 'Sign-in failed.', 'bad');
        } else {
          showStatus(`Recorded attendance for ${selected.firstName || selected.lastName || selected.id}.`, 'ok');
          clearSelectedStudent();
          const input = $('studentSearch');
          if (input) input.focus();
        }
        if (button) button.disabled = false;
      })
      .withFailureHandler((err) => {
        showStatus(err && err.message ? err.message : 'Sign-in failed.', 'bad');
        if (button) button.disabled = false;
      })
      .recordStudentSignIn(payload);
  }

  function recordManualSignIn(event) {
    event.preventDefault();
    const form = event.currentTarget;
    const details = {
      studentId: $('manualId') && $('manualId').value.trim(),
      firstName: $('manualFirst') && $('manualFirst').value.trim(),
      lastName : $('manualLast') && $('manualLast').value.trim(),
      school   : $('manualSchool') && $('manualSchool').value.trim(),
      email    : $('manualEmail') && $('manualEmail').value.trim(),
      grade    : $('manualGrade') && $('manualGrade').value.trim()
    };
    if (!details.studentId || !details.firstName || !details.lastName || !details.school || !details.email) {
      showStatus('Please complete all required fields.', 'bad');
      return;
    }
    const controls = Array.from(form.elements);
    controls.forEach((el) => { el.disabled = true; });
    showStatus('Recording attendance…', 'info');
    window.google.script.run
      .withSuccessHandler((res) => {
        if (!res || !res.ok) {
          showStatus((res && res.error) || 'Sign-in failed.', 'bad');
        } else {
          showStatus('Attendance recorded.', 'ok');
          form.reset();
          closeManualSheet();
        }
        controls.forEach((el) => { el.disabled = false; });
      })
      .withFailureHandler((err) => {
        showStatus(err && err.message ? err.message : 'Sign-in failed.', 'bad');
        controls.forEach((el) => { el.disabled = false; });
      })
      .recordStudentSignIn({
        sessionId: App.state.session && App.state.session.id,
        student: details
      });
  }

  function renderSessionSummary() {
    const summary = $('sessionSummary');
    if (summary && App.state.session) {
      summary.textContent = `${App.state.session.label || '(Session)'} – ${App.state.session.date || ''}`;
    }
  }

  function loadSessionAndRoster() {
    const params = new URLSearchParams(window.location.search || '');
    const sessionId = params.get('session') || '';
    const dateParam = params.get('date') || '';
    const today = new Date();
    const todayYMD = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
    const date = dateParam || todayYMD;

    const hiddenDate = $('sessionDateInput');
    if (hiddenDate) hiddenDate.value = date;

    window.google.script.run
      .withSuccessHandler((response) => {
        const sessions = response && Array.isArray(response.sessions) ? response.sessions : [];
        const match = sessions.find((session) => String(session.id) === String(sessionId));
        App.state.session = match || {
          id: sessionId,
          label: match ? match.label : '(Unknown session)',
          date,
          rowIndex: match ? match.rowIndex : null
        };
        App.state.selected = null;
        renderSelectedStudent();
        renderSessionSummary();
        window.google.script.run
          .withSuccessHandler((roster) => {
            setRoster(roster);
            if (window.console && typeof console.debug === 'function') {
              console.debug('[Roster] Loaded', App.state.roster.length);
            }
          })
          .withFailureHandler(() => { setRoster([]); })
          .listKnownStudentsLite();
      })
      .withFailureHandler((err) => {
        showStatus(err && err.message ? err.message : 'Session lookup failed.', 'bad');
      })
      .listActiveSignInSessions(date);
  }

  function init() {
    wireSuggest();
    renderSelectedStudent();

    const manualForm = $('manualEntryForm');
    if (manualForm) manualForm.addEventListener('submit', recordManualSignIn);

    const manualCue = $('manualCue');
    if (manualCue) {
      manualCue.addEventListener('click', openManualSheet);
      manualCue.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') {
          event.preventDefault();
          openManualSheet();
        }
      });
    }

    const closeBtn = $('manualClose');
    if (closeBtn) closeBtn.addEventListener('click', closeManualSheet);

    const overlay = $('manualSheet');
    if (overlay) overlay.addEventListener('click', (event) => {
      if (event.target === overlay) closeManualSheet();
    });

    const knownBtn = $('signInKnownBtn');
    if (knownBtn) knownBtn.addEventListener('click', recordKnownSignIn);

    const search = $('studentSearch');
    if (search) search.addEventListener('input', handleSearchInputChange);

    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape') closeManualSheet();
    });

    loadSessionAndRoster();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
